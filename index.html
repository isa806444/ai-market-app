<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Trading Terminal</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #0b1b33, #020617);
      color: white;
      min-height: 100vh;
      padding: 20px;
    }

    h1 { margin: 0 0 16px 0; font-size: 30px; text-align:center; }
    .live { color:#22c55e; font-size:14px; margin-left:8px; }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }

    .controls{
      max-width:600px;
      margin:0 auto 16px auto;
      text-align:center;
    }

    .search-box { display:flex; gap:10px; margin-bottom:10px; }
    input { flex:1; padding:10px; border-radius:10px; border:none; font-size:14px; }
    button { padding:10px 14px; border-radius:10px; border:none; font-size:14px; background:linear-gradient(90deg,#3b82f6,#22c55e); color:white; cursor:pointer; }

    .mode { display:flex; gap:10px; }
    .mode button { flex:1; background:#0f172a; color:#cbd5f5; border:1px solid rgba(255,255,255,0.1); }
    .mode .active { background:linear-gradient(90deg,#3b82f6,#22c55e); color:white; border:none; }

    .card { background:rgba(15,23,42,.7); border-radius:20px; padding:16px; margin-top:12px; box-shadow:0 0 0 1px rgba(255,255,255,.05); }
    .ticker { font-size:22px; font-weight:bold; }
    .price { float:right; color:#93c5fd; }

    .summary { margin-top:12px; color:#cbd5f5; line-height:1.4; }
    .pill { padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.15); cursor:pointer; font-size:13px; }
    .up{color:#22c55e;} .down{color:#ef4444;}
    .status { margin-top:20px; opacity:.7; text-align:center; }

    .panel{
      position:fixed;
      top:0;
      width:260px;
      height:100%;
      background:#020617;
      box-shadow:0 0 20px rgba(0,0,0,.6);
      padding:16px;
      transition:.3s;
      z-index:10;
    }

    .watch-panel{ right:-280px; }
    .watch-panel.open{ right:0; }

    .movers-panel{ left:-280px; }
    .movers-panel.open{ left:0; }

    .panel h3{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:0;
      gap:6px;
    }

    .close{ cursor:pointer; opacity:.6; }
    .close:hover{ opacity:1; }

    .watch-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px;
      border-bottom:1px solid rgba(255,255,255,.1);
      cursor:pointer;
      font-size:13px;
      transition: background .2s;
    }

    .watch-item.uprow{ background:rgba(34,197,94,.08); }
    .watch-item.downrow{ background:rgba(239,68,68,.08); }

    .watch-meta{
      text-align:right;
      font-size:12px;
      opacity:.9;
      white-space:nowrap;
    }

    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:6px;
      font-size:10px;
      margin-left:4px;
      opacity:.9;
    }
    .bull{ background:#14532d; color:#22c55e; }
    .bear{ background:#7f1d1d; color:#ef4444; }
    .neutral{ background:#1e293b; color:#cbd5f5; }

    .remove{color:#ef4444;font-size:12px;cursor:pointer;margin-left:6px;}
  </style>
</head>
<body>

<div class="topbar">
  <button onclick="toggleMovers()">üìä Movers</button>
  <h1>AI Trading Terminal <span class="live">‚óè Live</span></h1>
  <button onclick="toggleWatch()">üìå Watchlist</button>
</div>

<div class="controls">
  <div class="search-box">
    <input id="tickerInput" placeholder="TSLA, NVDA, BITF‚Ä¶" />
    <button id="analyzeBtn">Analyze</button>
  </div>

  <div class="mode">
    <button id="dayBtn" class="active">Day</button>
    <button id="swingBtn">Swing</button>
  </div>
</div>

<div id="result"></div>
<div class="status" id="status"></div>

<div id="watchPanel" class="panel watch-panel">
  <h3>
    Your Watchlist
    <span>
      <button style="padding:4px 8px;font-size:11px" onclick="refreshAll()">‚ü≥</button>
      <span class="close" onclick="toggleWatch()">‚úñ</span>
    </span>
  </h3>
  <div id="watchItems"></div>
</div>

<div id="moversPanel" class="panel movers-panel">
  <h3>
    Top Movers
    <span>
      <button style="padding:4px 8px;font-size:11px" onclick="loadScanner()">‚ü≥</button>
      <span class="close" onclick="toggleMovers()">‚úñ</span>
    </span>
  </h3>
  <div id="movers"></div>
</div>

<script>
const API = "https://ai-market-backend.onrender.com";

const tickerInput = document.getElementById("tickerInput");
const analyzeBtn = document.getElementById("analyzeBtn");
const dayBtn = document.getElementById("dayBtn");
const swingBtn = document.getElementById("swingBtn");
const statusEl = document.getElementById("status");
const resultEl = document.getElementById("result");
const moversEl = document.getElementById("movers");
const watchPanel = document.getElementById("watchPanel");
const moversPanel = document.getElementById("moversPanel");
const watchItems = document.getElementById("watchItems");

let mode = "day";
let watchTimer = null;
let moversTimer = null;

function toggleWatch(){
  watchPanel.classList.toggle("open");
  renderWatchlist();
  if(watchPanel.classList.contains("open")){
    startWatchAutoRefresh();
  } else {
    stopWatchAutoRefresh();
  }
}

function toggleMovers(){
  moversPanel.classList.toggle("open");
  if(moversPanel.classList.contains("open")){
    loadScanner();
    startMoversAutoRefresh();
  } else {
    stopMoversAutoRefresh();
  }
}

function startMoversAutoRefresh(){
  stopMoversAutoRefresh();
  moversTimer = setInterval(loadScanner, 60000);
}
function stopMoversAutoRefresh(){
  if(moversTimer){
    clearInterval(moversTimer);
    moversTimer = null;
  }
}

function getWatchlist(){
  return JSON.parse(localStorage.getItem("watchlist") || "[]");
}
function saveWatchlist(list){
  localStorage.setItem("watchlist", JSON.stringify(list));
}
function addWatch(t){
  const w = getWatchlist();
  if(!w.includes(t)){
    w.push(t);
    saveWatchlist(w);
    renderWatchlist();
  }
}
function removeWatch(t){
  const w = getWatchlist().filter(x=>x!==t);
  saveWatchlist(w);
  renderWatchlist();
}

async function renderWatchlist(){
  const w = getWatchlist();
  watchItems.innerHTML = "";

  for(const t of w){
    const row = document.createElement("div");
    row.className="watch-item";
    row.innerHTML = `
      <span>${t}</span>
      <span class="watch-meta">‚Ä¶</span>
    `;
    row.onclick = ()=> analyze(t);

    const meta = row.querySelector(".watch-meta");

    try{
      const r = await fetch(`${API}/analyze?ticker=${t}&mode=${mode}`);
      const d = await r.json();
      const ch = d.change ?? 0;
      const bias = (d.bias || "Neutral").toLowerCase();

      row.classList.toggle("uprow", ch > 0);
      row.classList.toggle("downrow", ch < 0);

      meta.innerHTML = `
        $${d.price ?? "‚Äî"} 
        <span class="${ch>=0?'up':'down'}">${ch}%</span>
        <span class="badge ${bias==='bullish'?'bull':bias==='bearish'?'bear':'neutral'}">${d.bias || "Neutral"}</span>
        <span class="remove">‚úñ</span>
      `;

      meta.querySelector(".remove").onclick = (e)=>{
        e.stopPropagation();
        removeWatch(t);
      };
    }catch{
      meta.textContent = "‚Äî";
    }

    watchItems.appendChild(row);
  }
}

function startWatchAutoRefresh(){
  stopWatchAutoRefresh();
  watchTimer = setInterval(renderWatchlist, 45000);
}
function stopWatchAutoRefresh(){
  if(watchTimer){
    clearInterval(watchTimer);
    watchTimer = null;
  }
}

async function refreshAll(){
  await renderWatchlist();
}

function setMode(m){
  mode = m;
  dayBtn.classList.toggle("active", m==="day");
  swingBtn.classList.toggle("active", m==="swing");
}

async function analyze(sym){
  const ticker = (sym || tickerInput.value.trim()).toUpperCase();
  if(!ticker) return;

  statusEl.textContent = "Analyzing‚Ä¶";
  resultEl.innerHTML = "";

  const r = await fetch(`${API}/analyze?ticker=${ticker}&mode=${mode}`);
  const d = await r.json();

  const levels = d.levels || {};
  const plan = d.plan || {};
  const targets = Array.isArray(plan.targets) ? plan.targets : [];
  const risks = Array.isArray(d.risk_notes) ? d.risk_notes : [];

  resultEl.innerHTML = `
    <div class="card">
      <div class="ticker">
        ${d.ticker}
        <span class="price">$${d.price ?? ""}</span>
      </div>

      <button onclick="addWatch('${d.ticker}')">‚≠ê Add to Watchlist</button>

      <div class="summary">
        <strong>Bias:</strong> ${d.bias || "Neutral"}<br/>
        <strong>Trend:</strong> ${d.trend || "‚Äî"}<br/><br/>

        <strong>Key Levels</strong><br/>
        Support: ${levels.support || "‚Äî"}<br/>
        Resistance: ${levels.resistance || "‚Äî"}<br/><br/>

        <strong>Trade Plan</strong><br/>
        Entry: ${plan.entry || "‚Äî"}<br/>
        Stop: ${plan.stop || "‚Äî"}<br/>
        ${targets.length ? `<ul>${targets.map(t=>`<li>${t}</li>`).join("")}</ul>` : ""}
        ${risks.length ? `<ul>${risks.map(r=>`<li>${r}</li>`).join("")}</ul>` : ""}

        <br/>${d.summary || ""}
      </div>
    </div>
  `;

  statusEl.textContent = "";
}

async function loadScanner(){
  moversEl.innerHTML = "Scanning‚Ä¶";
  try{
    const r = await fetch(`${API}/scanner`);
    const d = await r.json();
    const list = d.results || [];

    moversEl.innerHTML = "";
    list.forEach(x=>{
      const p = document.createElement("div");
      p.className = "pill";
      p.innerHTML = `${x.ticker} <span class="${x.change>=0?'up':'down'}">${x.change}%</span>`;
      p.onclick = ()=> analyze(x.ticker);
      moversEl.appendChild(p);
    });
  }catch{
    moversEl.innerHTML = "Scanner offline.";
  }
}

analyzeBtn.onclick = ()=> analyze();
dayBtn.onclick = ()=> setMode("day");
swingBtn.onclick = ()=> setMode("swing");

renderWatchlist();
</script>
</body>
</html>