<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Trading Terminal</title>
  <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #0b1b33, #020617);
      color: white;
      min-height: 100vh;
      padding: 20px;
    }

    h1 { margin: 0 0 12px 0; font-size: 28px; }
    .live { color:#22c55e; font-size:14px; margin-left:8px; }
    .row { display:flex; gap:10px; }
    .search-box { display:flex; gap:10px; margin-bottom:12px; }
    input { flex:1; padding:14px; border-radius:12px; border:none; font-size:16px; }
    button { padding:14px 18px; border-radius:12px; border:none; font-size:16px; background:linear-gradient(90deg,#3b82f6,#22c55e); color:white; cursor:pointer; }
    .mode button { flex:1; background:#0f172a; color:#cbd5f5; border:1px solid rgba(255,255,255,0.1); }
    .mode .active { background:linear-gradient(90deg,#3b82f6,#22c55e); color:white; border:none; }

    .card { background:rgba(15,23,42,.7); border-radius:20px; padding:16px; margin-top:12px; box-shadow:0 0 0 1px rgba(255,255,255,.05); }
    .ticker { font-size:22px; font-weight:bold; }
    .price { float:right; color:#93c5fd; }

    .summary { margin-top:12px; color:#cbd5f5; line-height:1.4; }
    .movers { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .pill { padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.15); cursor:pointer; font-size:13px; }
    .up{color:#22c55e;} .down{color:#ef4444;}
    .status { margin-top:20px; opacity:.7; text-align:center; }

    #chart { height:260px; width:100%; }
    .tf button { flex:1; background:#020617; color:#cbd5f5; border:1px solid rgba(255,255,255,.1); }
    .tf .active { background:#38bdf8; color:#020617; border:none; }
  </style>
</head>
<body>
  <h1>AI Trading Terminal <span class="live">● Live</span></h1>

  <div class="search-box">
    <input id="tickerInput" placeholder="TSLA, NVDA, BITF…" />
    <button id="analyzeBtn">Analyze</button>
  </div>

  <div class="row mode" style="margin-bottom:8px;">
    <button id="dayBtn" class="active">Day</button>
    <button id="swingBtn">Swing</button>
  </div>

  <div class="row tf" style="margin-bottom:8px;">
    <button id="tf1d" class="active">1D</button>
    <button id="tf5d">5D</button>
    <button id="tf1m">1M</button>
  </div>

  <div id="chart" class="card"></div>
  <div id="result"></div>

  <div class="card">
    <strong>Top Movers</strong>
    <div id="movers" class="movers"></div>
  </div>

  <div class="status" id="status"></div>

  <script>
    const API = "https://ai-market-backend.onrender.com";

    const tickerInput = document.getElementById("tickerInput");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const dayBtn = document.getElementById("dayBtn");
    const swingBtn = document.getElementById("swingBtn");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const moversEl = document.getElementById("movers");

    let mode = "day";
    let tf = "1D";
    let chart = null;
    let series = null;
    let lastTicker = "";
    let liveTimer = null;

    function setMode(m){
      mode = m;
      dayBtn.classList.toggle("active", m==="day");
      swingBtn.classList.toggle("active", m==="swing");
    }

    function setTF(t){
      tf = t;
      ["1D","5D","1M"].forEach(x=>{
        document.getElementById("tf"+x.toLowerCase()).classList.toggle("active", x===t);
      });
      if(lastTicker) startLive(lastTicker);
    }

    function initChart(){
      if (chart) return;
      const el = document.getElementById("chart");

      chart = LightweightCharts.createChart(el, {
        width: el.clientWidth,
        height: 260,
        layout:{ background:{ color:"#020617" }, textColor:"#cbd5f5" },
        grid:{ vertLines:{ color:"#111827" }, horzLines:{ color:"#111827" } }
      });
    }

    function newSeries(){
      if(series && chart){
        chart.removeSeries(series);
      }
      series = chart.addCandlestickSeries({
        upColor: '#22c55e',
        downColor: '#ef4444',
        borderUpColor: '#22c55e',
        borderDownColor: '#ef4444',
        wickUpColor: '#22c55e',
        wickDownColor: '#ef4444',
      });
    }

    async function fetchChartData(ticker){
      let r = await fetch(`${API}/chart?ticker=${ticker}&tf=${tf}`);
      let data = await r.json();

      if(!Array.isArray(data) || !data.length){
        r = await fetch(`${API}/chart?ticker=${ticker}&tf=5D`);
        data = await r.json();
      }

      if(Array.isArray(data) && data.length){
        series.setData(data);
        chart.timeScale().fitContent();
      }
    }

    function stopLive(){
      if(liveTimer){
        clearInterval(liveTimer);
        liveTimer = null;
      }
    }

    async function startLive(ticker){
      stopLive();
      initChart();
      newSeries();

      await fetchChartData(ticker);
      statusEl.textContent = `Live feed active for ${ticker.toUpperCase()} (polling)…`;

      liveTimer = setInterval(()=>{
        fetchChartData(ticker);
      }, 1000);
    }

    async function analyze(sym){
      const ticker = (sym || tickerInput.value.trim()).toUpperCase();
      if(!ticker) return;

      lastTicker = ticker;
      statusEl.textContent = "Connecting to live feed…";
      resultEl.innerHTML = "";

      try{
        await startLive(ticker);

        const r = await fetch(`${API}/analyze?ticker=${encodeURIComponent(ticker)}&mode=${mode}`);
        const d = await r.json();

        if(d.error){
          statusEl.textContent = d.error;
          return;
        }

        const levels = d.levels || {};
        const plan = d.plan || {};
        const targets = Array.isArray(plan.targets) ? plan.targets : [];
        const risks = Array.isArray(d.risk_notes) ? d.risk_notes : [];

        resultEl.innerHTML = `
          <div class="card">
            <div class="ticker">
              ${d.ticker}
              <span class="price">$${d.price ?? ""}</span>
            </div>

            <div class="summary">
              <strong>Bias:</strong> ${d.bias || "Neutral"}<br/>
              <strong>Trend:</strong> ${d.trend || "—"}<br/><br/>

              <strong>Key Levels</strong><br/>
              Support: ${levels.support || "—"}<br/>
              Resistance: ${levels.resistance || "—"}<br/><br/>

              <strong>Trade Plan</strong><br/>
              Entry: ${plan.entry || "—"}<br/>
              Stop: ${plan.stop || "—"}<br/>
              ${targets.length ? `
                Targets:
                <ul style="margin:6px 0 6px 16px;">
                  ${targets.map(t => `<li>${t}</li>`).join("")}
                </ul>
              ` : ""}

              ${risks.length ? `
                <strong>Risk Notes</strong>
                <ul style="margin:6px 0 0 16px;">
                  ${risks.map(r => `<li>${r}</li>`).join("")}
                </ul>
              ` : ""}

              <br/>
              ${d.summary || ""}
            </div>
          </div>
        `;
      }catch(e){
        console.error(e);
        statusEl.textContent = "Frontend error – check console.";
      }
    }

    async function loadMovers(){
      const r = await fetch(`${API}/movers`);
      const list = await r.json();
      moversEl.innerHTML = "";
      list.forEach(x=>{
        const p = document.createElement("div");
        p.className = "pill";
        p.innerHTML = `${x.ticker} <span class="${x.change>=0?'up':'down'}">${x.change}%</span>`;
        p.onclick = ()=> analyze(x.ticker);
        moversEl.appendChild(p);
      });
    }

    analyzeBtn.onclick = ()=> analyze();
    dayBtn.onclick = ()=> setMode("day");
    swingBtn.onclick = ()=> setMode("swing");
    document.getElementById("tf1d").onclick = ()=> setTF("1D");
    document.getElementById("tf5d").onclick = ()=> setTF("5D");
    document.getElementById("tf1m").onclick = ()=> setTF("1M");

    loadMovers();
  </script>
</body>
</html>